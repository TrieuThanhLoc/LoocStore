<p class="thanh_toan-title">
    Thanh Toán
</p>
<form class="thanh_toan-body" method="POST" action="../thanhtoan/dathang">
    {{#each giohangthanhtoan.giohang}}
    <div class="body-thong_tin_sp">
        <div class="sp-img">
            <img src="../images/anh_chi_tiet/{{this.hangsx}}/{{this.anh}}/{{this.anh}}.jpg" alt="" >
        </div>
        <div class="sp-thong_tin">
            <p class="sp-thong_tin-ten">
                {{this.tensp}}
                <input type="text" name="masp[]" value="{{this.masp}}" hidden>
                <input type="text" name="tensp[]" value="{{this.tensp}}" hidden>
            </p>
            <div class="thong_tin-chung">
                <div class="thong_tin-thuoc_tinh">
                    <div class="thuoc_tinh-mau">
                        <p>Mau sắc</p>
                        <p>{{this.mausac}}</p>
                        <input type="text" name="mausac[]" value="{{this.mausac}}" hidden>
                    </div>
                    <div class="thuoc_tinh-so_luong">
                        <p>Số lượng</p>
                        <p >{{this.soluongsp}}</p>
                        <input type="text" name="soluongsp[]" value="{{this.soluongsp}}" hidden>
                    </div>
                    
                </div>
                <div class="">
                    <div class="sp_gia " id="sp_gia">
                    <span class="gia_format">{{this.tongtamtinhspnay}}</span> VND
                    </div>
                    
                </div>
            </div>
        </div>
    </div>    
    {{/each}}
    {{!-- <div class="body-thong_tin-km">
        <p class="km-title">
            Khuyến mãi
        </p>
        <div class="km-item">
            <i class="fa-regular fa-circle-check" style="color: #ff0000;"></i>
             Khuyen mai 
        </div>
       
    </div> --}}
    <div class="body-thong_tin_kh">
        <p class="kh-title">
            Thông tin người đặt hàng
        </p>
        <div class="row">
            <div class="col">
                <input type="text" class="form-control" placeholder="Số điện thoại" value="{{thongtintaikhoan.sodtnv}}{{thongtintaikhoan.sodtkh}}" name="sodtkh" id="sodtkh" required>
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="Họ và tên" value="{{thongtintaikhoan.tennv}}{{thongtintaikhoan.tenkh}}" name="tenkh" id="tenkh" onchange="TaoMaDonTuDong()" required>
            </div>
            {{!-- <input type="text" id="madh" name="madh" hidden> --}}
            <input type="text" id="makh" name="makh" value="{{thongtintaikhoan.makh}}" hidden>
        </div>
       <div class="chon_dia_chi">
            <p class="chon_dia_chi-title">
                Chọn địa chỉ giao hàng
            </p>
            {{#each diachikhachhangs}}
            <div class="chon_dia_chi-item">
                <input 
                    type="radio" 
                    class="chon_dia_chi-item-diachi" 
                    id="{{this._id}}" name="diachigiaohang" 
                    value=" {{this.diachicuthe}}, {{this.phuongxa}}, {{this.quanhuyen}}, {{this.tinhtp}}" required>
                </input>
                <label for="{{this._id}}"> {{this.diachicuthe}}, {{this.phuongxa}}, {{this.quanhuyen}}, {{this.tinhtp}}</label>
            </div>
            {{/each}}
            <div class="chon_dia_chi-btn">
                <button type="button" class="btn btn-light" id="btn_them_dia_chi" data-bs-target="#modal_them_dia_chi" data-bs-toggle="modal">
                    <i class="fa-solid fa-plus"></i>
                    Thêm địa chỉ mới
                </button>
            </div>
       </div>
    </div>
    <div class="body-phuong_thuc_thanh_toan">
        <div class="body-phuong_thuc_thanh_toan-chon">
            <span>
                Chọn phương thức thanh toán
            </span>
        </div>
        <div class="form-check">
            <input class="form-check-input input_phuongthucthanhtoan" type="radio" name="phuongthucthanhtoan" id="thanh_toan_khi_nhan_hang" value="cod">
            <label class="form-check-label" for="thanh_toan_khi_nhan_hang">
                Thanh toán khi nhận hàng
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input input_phuongthucthanhtoan" type="radio" name="phuongthucthanhtoan" id="thanh_toan_online" value="online">
            <label class="form-check-label" for="thanh_toan_online">
                Thanh toán online
            </label>
            <div class="thanh_toan_online-modal d-none">
                {{!-- Thanh toán tạm thời --}}
                <input class="manh_input" type="radio" name="manh" id="ncb" value="ncb" hidden>
                    <label for="ncb" class="manh-lable">
                        <img src="./images/logoNganHang/ncb.jpg" alt="">
                    </label>
                <input class="manh_input" type="radio" name="manh" id="acb" value="acb" hidden>
                    <label for="acb" class="manh-lable">
                        <img src="./images/logoNganHang/acb.jpg" alt="">
                    </label>
                <input class="manh_input" type="radio" name="manh" id="ocb" value="ocb" hidden>
                    <label for="ocb" class="manh-lable">
                        <img src="./images/logoNganHang/ocb.jpg" alt="">
                    </label>
                

                {{!-- Liên kết ngân hàng --}}
                {{!-- <div class="thanh_toan_online-modal--nganhangdalienket">
                    <div class="nganhangdalienket">
                        {{#each nganhanglienkets}}
                        <label for="{{this.manh}}" class="nganhangdalienket-lable">
                            <input id="{{this.manh}}" type="radio" name="manh" style="outline-style: none;" value="{{this.manh}}">
                            <img src="../../images/logoNganHang/{{this.manh}}.jpg" alt="" class="nganhangdalienket-img">
                            <div class="nganhangdalienket-info">
                                <p class="nganhangdalienket-info--tenchuthe">
                                   {{this.tenchuthe}}
                                </p>
                                <p class="nganhangdalienket-info--sothe">
                                    {{this.sothe}}
                                </p>
                            </div>
                        </label>
                        {{/each}}
                    </div>
                    <div class="lien_ket_ngan_hang-btn">
                        <button type="button" class="btn btn-primary" id="btn_them_lien_ket_ngan_hang" data-bs-target="#modal_lien_ket_ngan_hang"
                            data-bs-toggle="modal">
                            <i class="fa-solid fa-plus"></i>
                            Liên kết ngân hàng
                        </button>
                    </div>
                </div> --}}
                <div class="thanh_toan_online-modal--lienket">

                </div>
            </div>
        </div>
    </div>
    <div class="body-tong_tien">
        <div class="body-tong_tien-title">
            <p class="title-item">Tổng tiền:</p>
            <p class="title-item">GIảm giá khuyến mãi:</p>
            <p class="title-item">Cần thanh toán:</p>
        </div>
        <div class="body-tong_tien-thanh_tien">
            <p class="thanh_tien-item" >
                <span id="tongtien">
                    <span class="gia_format">{{giohangthanhtoan.tongtien}}</span>
                </span> VND
            </p>
            <input type="text" name="tongtien" id="input_tongtien" value="{{giohangthanhtoan.tongtien}}" hidden>
            <p class="thanh_tien-item" >
                <span id="giamgia">
                    <span class="gia_format">{{giohangthanhtoan.giamgia}}</span>
                </span> VND
            </p>
            <input type="text" name="giamgia" id="input_giamgia" value="{{giohangthanhtoan.giamgia}}" hidden>
            <p class="thanh_tien-item" style="color: red;" >
                <span id="tienthanhtoan">
                    <span class="gia_format">{{giohangthanhtoan.tongtienthanhtoan}}</span>
                </span> VND
            </p>
            <input type="text" name="tienthanhtoan" id="input_tienthanhtoan" value="{{giohangthanhtoan.tongtienthanhtoan}}" hidden>
        </div>
    </div>
    <input type="text" value="{{giohangthanhtoan._id}}" name="_idgiohangthanhtoan" hidden>
        <button type="submit" class="btn btn-danger">Hoàn tất đặt hàng</button>
</form>

{{!-- Modal thêm địa chỉ mới --}}
<div class="modal fade" id="modal_them_dia_chi" tabindex="-1" aria-labelledby="modalthemdiachi" aria-hidden="true">
    <div class="modal-dialog">
        <div class="them_dia_chi modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalthemdiachi">Thêm địa chỉ mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/nguoidung/themdiachi/{{thongtintaikhoan.manv}}{{thongtintaikhoan.makh}}" id="form_luu_dia_chi">
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Địa chỉ cụ thể:</label>
                        <input type="text" class="form-control" name="diachicuthe">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Phường/xã:</label>
                        <input type="text" class="form-control" name="phuongxa">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Quận/huyện:</label>
                        <input type="text" class="form-control" name="quanhuyen">
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Tỉnh/Thành phố:</label>
                        <input type="text" class="form-control" name="tinhtp">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btn_luu_dia_chi">Lưu địa chỉ</button>
            </div>
        </div>
    </div>
</div>

{{!-- Modal liên kết ngân hàng --}}
{{!-- <div class="modal fade" id="modal_lien_ket_ngan_hang" tabindex="-1" aria-labelledby="modalthemlienketnganhang" aria-hidden="true">
    <div class="modal-dialog">
        <div class="them_dia_chi modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalthemlienketnganhang">Thông tin thẻ ngân hàng <span></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/thanhtoan/lienketnganhang/{{thongtintaikhoan.makh}}"
                    id="form_them_lien_ket_ngan_hang">
                    <div class="mb-3">
                        <p for="recipient-name" class="col-form-label">Chọn ngân hàng</p>
                        <input class="manh_input" type="radio"name="manh" id="ncb" value="ncb" hidden>
                            <label for="ncb" class="manh-lable">
                                <img src="./images/logoNganHang/ncb.jpg" alt="">
                            </label>
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Số thẻ:</label>
                        <input type="text" class="form-control" name="sothe" id="sothe" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Tên chủ thẻ <i><strong>(NGUYEN VAN A)</strong></i></label>
                        <input type="text" class="form-control" name="tenchuthe" id="tenchuthe" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipient-name" class="col-form-label">Ngày phát hàng <i><strong>(dd/mm)</strong></i></label>
                        <input type="text" class="form-control" name="ngayphahanh" id="ngayphahanh" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btn_lien_ket_ngan_hang">Liên kết</button>
            </div>
        </div>
    </div>
</div> --}}

<script>
    //Thanh toan momo tạm thời
    document.addEventListener('DOMContentLoaded', function(){
        var formLuuDiaChi = $('#form_luu_dia_chi');
        var btnLuuDiaChi = $('#btn_luu_dia_chi');

        var formThemNganHang = $('#form_them_lien_ket_ngan_hang');
        var btnThemLienKet = $('#btn_lien_ket_ngan_hang');

        var inputPhuongThucThanhToan = $('.input_phuongthucthanhtoan')
        var inputThanhToanOnline = $('#thanh_toan_online')
        var modalThanhToanOnline = $('.thanh_toan_online-modal')

        var inputManh = $('.manh_input');
        var maNHLable = $('.manh-lable')
        var valueInputLienKetNH = $('#modal_lien_ket_ngan_hang .mb-3 input')
        
        //Hien thi lua chon ngan hang
        inputPhuongThucThanhToan.change(function(){
            if($(this).val() == 'online'){
                modalThanhToanOnline.removeClass('d-none')
            }else{
                modalThanhToanOnline.addClass('d-none')
            }
        })

        //modal them ngan hang lien ket
        inputManh.change(function(){
            $(maNHLable).removeClass('nganhang_checked')
            $(this.nextElementSibling).addClass('nganhang_checked')
        })

        valueInputLienKetNH.keyup(function(){
            if($(this).val() != ''){
                $(this).attr('style','box-shadow: none')
            }else{
                $(this).attr('style', 'box-shadow: 0 0 1px 1px red')   
            }
        })
        btnThemLienKet.click(function () {
            var valueTrong = false;
            valueInputLienKetNH.each((index, item)=>{
                if($(item).val() == ''){
                    $(item).attr('style','box-shadow: 0 0 1px 1px red')
                    valueTrong = true
                }
            })
            if(!valueTrong){
                formThemNganHang.submit();
            }
        })

        btnLuuDiaChi.click(function(){
            formLuuDiaChi.submit();
        })


    })
</script>

